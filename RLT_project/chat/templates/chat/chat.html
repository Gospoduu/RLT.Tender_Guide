<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RLT ‚Ä¢ –ß–∞—Ç</title>
  <style>
    :root {
      --bg:#1f0056;
      --bg2:#2b007a;
      --card:#ffffff;
      --ink:#0f172a;
      --sub:#6b7280;
      --accent:#6a5cff;
      --accent2:#8d7bff;
      --bubble:#f7f8fc;
      --radius:16px;
    }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, var(--bg), var(--bg2) 60%, #f3f4f7 60%);
    }

    .topbar {
      background: transparent;
      padding: 22px 18px;
    }

    .brand {
      max-width: 1100px;
      margin: 0 auto;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand__logo {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: rgba(255, 255, 255, .15);
    }

    .brand__title {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
      padding: 0 18px 18px;
    }

    .hero {
      color: #fff;
      padding: 28px 0;
      flex-shrink: 0;
    }

    .hero h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 800;
    }

    .hero p {
      margin: 0;
      color: rgba(255, 255, 255, .85);
    }

    .panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(17, 24, 39, .12);
      overflow: hidden;
    }

    .chat {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg {
      display: flex;
      gap: 10px;
    }

    .msg.user {
      justify-content: flex-end;
    }

    .bubble {
      max-width: 75%;
      background: var(--bubble);
      border: 1px solid #e6e8f0;
      color: var(--ink);
      padding: 10px 14px;
      border-radius: 14px;
      word-wrap: break-word;
      white-space: normal;
    }

    .user .bubble {
      background: #efeefe;
      border-color: #dbd8ff;
    }

    .bot .bubble {
      background: #fff;
    }

    .cite {
      font-size: 13px;
      color: var(--sub);
      margin-top: -6px;
      margin-left: 8px;
      line-height: 1.4;
    }

    .cite a {
      color: var(--accent2);
      text-decoration: none;
    }

    .composer {
      border-top: 1px solid #eef0f5;
      padding: 14px;
      background: #fafbff;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-shrink: 0;
    }

    .box {
      flex: 1;
      background: #fff;
      border: 1px solid #e6e8f0;
      border-radius: 999px;
      display: flex;
      align-items: center;
      padding: 8px 14px;
      gap: 10px;
    }

    .box input {
      border: 0;
      outline: 0;
      width: 100%;
      font-size: 16px;
      padding: 8px 2px;
      background: transparent;
    }

    .send {
      border: 0;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #fff;
      padding: 12px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 6px 16px rgba(106, 92, 255, .35);
    }

    .send:disabled {
      opacity: .7;
      cursor: not-allowed;
    }

    .fb-btn {
      border: none;
      background: none;
      font-size: 18px;
      margin: 0 6px;
      cursor: pointer;
      transition: 0.2s;
    }

    .fb-btn:hover {
      transform: scale(1.2);
    }

    .fb-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    @media (max-width: 720px) {
      .bubble {
        max-width: 92%;
      }
      .hero {
        padding: 14px 0;
      }
      .wrap {
        padding: 0 12px 12px;
      }
    }
  </style>
</head>
<body>
<header class="topbar">
  <div class="brand">
    <div class="brand__logo"></div>
    <div class="brand__title">RLT ‚Ä¢ –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ –∑–∞–∫—É–ø–∫–∞–º</div>
  </div>
</header>

<div class="wrap">
  <section class="hero">
    <h1>–ó–∞–¥–∞–π—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –í–∞—Å –≤–æ–ø—Ä–æ—Å</h1>
    <p>–°–∏—Å—Ç–µ–º–∞ –Ω–∞–π–¥—ë—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.</p>
  </section>

  <section class="panel">
    <div id="chat" class="chat">
      <div class="msg bot">
        <div class="bubble">
          –ü—Ä–∏–≤–µ—Ç! –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä: <br>¬´–ö—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –∑–∞–∫–∞–∑—á–∏–∫–æ–º –ø–æ 44-–§–ó –∏ –∫–∞–∫–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏?¬ª
        </div>
      </div>
    </div>

    <div class="composer">
      <div class="box">
        <input id="q" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ä–æ–∫–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏–∑–≤–µ—â–µ–Ω–∏—è –ø–æ 44‚Äë–§–ó" autofocus />
      </div>
      <button id="send" class="send" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </section>
</div>

<script>
function escapeHTML(str){
  return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function formatMarkdown(text){
  return escapeHTML(text)
    .replace(/\n/g, "<br>")
    .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
    .replace(/_(.*?)_/g, "<i>$1</i>");
}

function addMsg(role, text, citations, questionText){
  const box = document.getElementById('chat');
  const row = document.createElement('div'); row.className = 'msg ' + role;
  const bubble = document.createElement('div'); bubble.className = 'bubble';
  bubble.innerHTML = formatMarkdown(text);
  row.appendChild(bubble); box.appendChild(row);

  if(Array.isArray(citations) && citations.length){
    const cite = document.createElement('div'); cite.className='cite';
    cite.innerHTML = citations.map((c,i)=>
      `<div>[${i+1}] <a href="${c.url}" target="_blank">${c.title}</a><br>${c.snippet}</div>`
    ).join('<br>');
    box.appendChild(cite);
  }

  if(role === 'bot'){
    addFeedbackBlock(row, questionText, text);
  }

  box.scrollTop = box.scrollHeight;
}

function addFeedbackBlock(parentElem, question, answer) {
  const block = document.createElement('div');
  block.className = 'cite';
  block.innerHTML = `
    <span>–ë—ã–ª –ª–∏ —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª–µ–∑–µ–Ω?</span>
    <button class="fb-btn" onclick="submitFeedback(this, 'like', ${JSON.stringify(question)}, ${JSON.stringify(answer)})">üëç</button>
    <button class="fb-btn" onclick="submitFeedback(this, 'dislike', ${JSON.stringify(question)}, ${JSON.stringify(answer)})">üëé</button>
  `;
  parentElem.appendChild(block);
}

async function submitFeedback(btn, type, question, answer){
  const payload = { type, question, answer };
  btn.parentElement.querySelectorAll('button').forEach(b => b.disabled = true);
  try {
    await fetch('/api/feedback/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(payload)
    });
    btn.style.fontWeight = 'bold';
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∏–¥–±—ç–∫–∞:", e);
  }
}

function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return m ? m.pop() : '';
}

async function send(){
  const input = document.getElementById('q');
  const text = input.value.trim(); if(!text) return;
  addMsg('user', text);
  input.value = ''; input.focus();

  const btn = document.getElementById('send'); btn.disabled = true; btn.textContent = '–ò—â–µ–º‚Ä¶';
  try{
    const r = await fetch('/api/ask', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({question: text})
    });
    const j = await r.json();
    addMsg('bot', j.answer || '–ì–æ—Ç–æ–≤–æ.', j.results || [], text);
  }catch(e){
    addMsg('bot', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.');
  }finally{
    btn.disabled = false; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
  }
}

document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); }
});
</script>
</body>
</html>


